"use strict";(()=>{var e={};e.id=349,e.ids=[349],e.modules={11185:e=>{e.exports=require("mongoose")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},46280:(e,t,a)=>{a.r(t),a.d(t,{config:()=>m,default:()=>p,routeModule:()=>g});var r={};a.r(r),a.d(r,{default:()=>handler});var s=a(71802),i=a(47153),n=a(56249),d=a(38574),o=a(11185),l=a.n(o);let c=new o.Schema({email:{type:String,unique:[!0,"Email already exists!"],required:[!0,"Email is required!"]},name:{type:String},avatar:{type:String,default:"https://th.bing.com/th/id/OIP.n1C1oxOvYLLyDIavrBFoNQAAAA?w=178&h=180&c=7&r=0&o=5&dpr=1.3&pid=1.7"},password:{type:String},contacts:{type:Array}},{timestamps:!0});o.models.User||(0,o.model)("User",c);var u=a(72225);async function handler(e,t){let{chatId:a}=e.query,{users:r,content:s}=JSON.parse(e.body);try{let e=await u.Z.findById(a);if(!e)return t.status(402).json({message:" Chat doesnt exists",error:!0});let i=await d.Z.create({sender:r.senderId,content:s,chat:a,status:"sent"}),n=await u.Z.findByIdAndUpdate(a,{$set:{lastMessage:i._id},$inc:{unreadCount:1}},{new:!0}),o=await d.Z.aggregate([{$match:{_id:new(l()).Types.ObjectId(i._id)}},{$lookup:{from:"users",foreignField:"_id",localField:"sender",as:"sender",pipeline:[{$project:{avatar:1,email:1,name:1}}]}},{$addFields:{sender:{$first:"$sender"}}}]),c=o[0];n.participants.forEach(e=>{if(e.toString()!==r.senderId)return t?.socket?.server?.io?.emit("receive-message",c),t.status(200).json(c)})}catch(e){return console.log("[SOCKET_MESSAGE]: ",e),t.status(500).json({message:"Internal Error"})}}let p=(0,n.l)(r,"default"),m=(0,n.l)(r,"config"),g=new s.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/socket/message/[chatId]",pathname:"/api/socket/message/[chatId]",bundlePath:"",filename:""},userland:r})}};var t=require("../../../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),a=t.X(0,[222,715],()=>__webpack_exec__(46280));module.exports=a})();