import _e,{useState as Le,useCallback as Ne,forwardRef as be}from"react";import xe from"next/image";import{getTransformations as Te}from"@cloudinary-util/util";import{transformationPlugins as Ae}from"@cloudinary-util/url-loader";async function B(e){let{src:o}=e;try{await new Promise((l,d)=>{fetch(o).then(t=>{if(!t.ok){d(t);return}l(t)})})}catch(l){return l.status===423?await B(e):!1}return!0}function b(e){if(!e)throw new Error("A Cloudinary Cloud name is required, please make sure NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME is set and configured in your environment.")}import{constructCloudinaryUrl as we}from"@cloudinary-util/url-loader";import Pe from"next/package.json";var ue={name:"next-cloudinary",version:"5.20.0",license:"MIT",main:"./dist/index.js",module:"./dist/index.mjs",types:"./dist/index.d.ts",source:"src/index.ts",scripts:{build:"tsup",dev:"tsup --watch",prepublishOnly:"cp ../README.md . && cp ../LICENSE . && yarn build",postpublish:"rm ./README.md && rm ./LICENSE",test:"jest","test:app":'NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME="test" yarn build && cd tests/nextjs-app && yarn build'},dependencies:{"@cloudinary-util/url-loader":"^4.1.1","@cloudinary-util/util":"^2.3.0"},devDependencies:{"@babel/core":"^7.23.2","@babel/preset-env":"^7.23.2","@types/jest":"^29.5.6","@types/react":"^18.2.33","@types/react-dom":"^18.2.14","babel-jest":"^29.7.0",dotenv:"^16.3.1",jest:"^29.7.0","jest-environment-jsdom":"^29.7.0",mkdirp:"^3.0.1","ts-jest":"^29.1.1",tsup:"^7.2.0",typescript:"^5.2.2"},peerDependencies:{next:"^12 || ^13 || ^14",react:"^17 || ^18"}};var Y="V",$=ue.version,z=Pe.version;function I(e,o,l){var t,r;let d=(r=(t=o==null?void 0:o.cloud)==null?void 0:t.cloudName)!=null?r:process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME;return b(d),we({options:e,config:Object.assign({cloud:{cloudName:d}},o),analytics:Object.assign({sdkCode:Y,sdkSemver:$,techVersion:z,feature:""},l)})}function ee({loaderOptions:e,imageProps:o,cldOptions:l,cldConfig:d={}}){let t={...o,...l};t.width=typeof t.width=="string"?parseInt(t.width):t.width,t.height=typeof t.height=="string"?parseInt(t.height):t.height;let r;return typeof(e==null?void 0:e.width)=="number"&&typeof t.width=="number"&&e.width!==t.width?r=e.width:typeof(e==null?void 0:e.width)=="number"&&typeof(t==null?void 0:t.width)!="number"&&(r=e.width,t.width=r),t.width&&r&&r<t.width&&(t.widthResize=e.width),I(t,d)}var ve=be(function(o,l){let d=!1,t=["deliveryType","preserveTransformations","strictTransformations","assetType"];Ae.forEach(({props:n})=>{Object.keys(n).forEach(O=>{if(t.includes(O))throw new Error(`Option ${O} already exists!`);t.push(O)})});let r={alt:o.alt,src:o.src};Object.keys(o).filter(n=>!t.includes(n)).forEach(n=>r[n]=o[n]);let p=Object.keys(r).map(n=>`${n}:${r[n]}`).join(";"),[y,C]=Le(p),c={};if(t.forEach(n=>{o[n]&&(c[n]=o[n]||void 0)}),o.preserveTransformations)try{let n=Te(o.src).map(h=>h.join(","));c.rawTransformations=[...n.flat(),...o.rawTransformations||[]]}catch(n){console.warn(`Failed to preserve transformations: ${n.message}`)}let i=process.env.__NEXT_IMAGE_OPTS||{};(o.unoptimized===!0||(i==null?void 0:i.unoptimized)===!0)&&(r.src=I({...c,width:r.width,height:r.height,src:r.src,format:"default",quality:"default"},o.config));async function U(n){let h=!0;if(d)return;if(d=!0,typeof o.onError=="function"){let w=o.onError(n);typeof w=="boolean"&&w===!1&&(h=!1)}else typeof o.onError=="boolean"&&o.onError===!1&&(h=!1);if(h===!1)return;let O=n.target;await B({src:O.src})&&C(`${p};${Date.now()}`)}let E=Ne(U,[B,p]),P=xe;return"default"in P&&(P=P.default),_e.createElement(P,{key:y,...r,loader:n=>ee({loaderOptions:n,imageProps:r,cldOptions:c,cldConfig:o.config}),onError:E,ref:l})}),ge=ve;import L from"react";import We from"next/head";var Me="summary_large_image",Ve=({excludeTags:e=[],twitterTitle:o,keys:l={},...d})=>{let{alt:t}=d,r={...d,crop:d.crop||"fill",gravity:d.gravity||"center",height:d.height||1254,src:d.src,width:d.width||2400,widthResize:d.width||1200},p=typeof r.width=="string"?parseInt(r.width):r.width,y=typeof r.height=="string"?parseInt(r.height):r.height;typeof y=="number"&&typeof p=="number"&&(y=1200/p*y),p=1200;let C=I({...r,format:d.format||"jpg"}),c=I({...r,format:d.format||"webp"}),i={"og:image":"og-image","og:image:secure_url":"og-image-secureurl","og:image:width":"og-image-width","og:image:height":"og-image-height","og:image:alt":"og-image-alt","twitter:title":"twitter-title","twitter:card":"twitter-card","twitter:image":"twitter-image",...l};return L.createElement(We,null,L.createElement("meta",{key:i["og:image"],property:"og:image",content:C}),L.createElement("meta",{key:i["og:image:secure_url"],property:"og:image:secure_url",content:C}),L.createElement("meta",{key:i["og:image:width"],property:"og:image:width",content:`${p}`}),L.createElement("meta",{key:i["og:image:height"],property:"og:image:height",content:`${y}`}),t&&L.createElement("meta",{key:i["og:image:alt"],property:"og:image:alt",content:t}),!e.includes("twitter:title")&&L.createElement("meta",{key:i["twitter:title"],property:"twitter:title",content:o||" "}),L.createElement("meta",{key:i["twitter:card"],property:"twitter:card",content:Me}),L.createElement("meta",{key:i["twitter:image"],property:"twitter:image",content:c}))},me=Ve;import K from"react";import re,{useState as ne,useEffect as ie,useRef as ye}from"react";import Ge from"next/script";function fe(e){return window&&"requestIdleCallback"in window?requestIdleCallback(e):setTimeout(()=>e(),1)}var De=["success","display-changed"],Se={abort:"onAbort","batch-cancelled":"onBatchCancelled","display-changed":"onDisplayChanged",publicid:"onPublicId","queues-end":"onQueuesEnd","queues-start":"onQueuesStart",retry:"onRetry","show-completed":"onShowCompleted","source-changed":"onSourceChanged",success:"onSuccess",tags:"onTags","upload-added":"onUploadAdded"},ke=({children:e,onClose:o,onError:l,onOpen:d,onUpload:t,options:r,signatureEndpoint:p,uploadPreset:y,...C})=>{let c=ye(),i=ye(),U=!!p,[E,P]=ne(void 0),[n,h]=ne(void 0),[O,W]=ne(!0),w={cloudName:process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME,uploadPreset:y||process.env.NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET,apiKey:process.env.NEXT_PUBLIC_CLOUDINARY_API_KEY,...r};b(process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME),U&&(w.uploadSignature=_,w.apiKey||console.warn("Missing dependency: Signed Upload requires an API key")),ie(()=>{if(typeof n=="undefined")return;let a=n.event==="success",g=n.event==="display-changed"&&n.info==="hidden";a&&typeof t=="function"&&t(n,i.current),g&&typeof o=="function"&&o(i.current)},[n]),ie(()=>{E&&typeof l=="function"&&l(E,i.current)},[E]);function D(){W(!1),c.current||(c.current=window.cloudinary),fe(()=>{i.current||(i.current=A())})}ie(()=>()=>{var a;(a=i.current)==null||a.destroy(),i.current=void 0},[]);function _(a,g){if(typeof p=="undefined")throw Error("Failed to generate signature: signatureEndpoint undefined.");fetch(p,{method:"POST",body:JSON.stringify({paramsToSign:g})}).then(m=>m.json()).then(({signature:m})=>{a(m)})}function u(a,g=[]){if(i.current||(i.current=A()),typeof(i==null?void 0:i.current[a])=="function")return i.current[a](...g)}function M(a){u("close",[a])}function x(a){return u("destroy",[a])}function S(){u("hide")}function k(){return u("isDestroyed")}function V(){return u("isMinimized")}function F(){return u("isShowing")}function T(){u("minimize")}function H(a,g){u("open",[a,g]),typeof d=="function"&&d(i.current)}function J(){u("show")}function j(){u("update")}let X={close:M,destroy:x,hide:S,isDestroyed:k,isMinimized:V,isShowing:F,minimize:T,open:H,show:J,update:j};function A(){var a;return(a=c.current)==null?void 0:a.createUploadWidget(w,(g,m)=>{if(g&&g!==null&&P(g),typeof(m==null?void 0:m.event)=="string"){De.includes(m==null?void 0:m.event)&&h(m);let N=Se[m.event];if(typeof N=="string"&&typeof C[N]=="function"&&typeof C[N]){let Z=C[N];Z(m,{widget:i.current,...X})}}})}return re.createElement(re.Fragment,null,typeof e=="function"&&e({cloudinary:c.current,widget:i.current,results:n,error:E,isLoading:O,...X}),re.createElement(Ge,{id:`cloudinary-uploadwidget-${Math.floor(Math.random()*100)}`,src:"https://upload-widget.cloudinary.com/global/all.js",onLoad:D,onError:a=>console.error(`Failed to load Cloudinary Upload Widget: ${a.message}`)}))},q=ke;var je=({className:e,children:o,onClick:l,onError:d,onOpen:t,onUpload:r,onAbort:p,onBatchCancelled:y,onClose:C,onDisplayChanged:c,onPublicId:i,onQueuesEnd:U,onQueuesStart:E,onRetry:P,onShowCompleted:n,onSourceChanged:h,onSuccess:O,onTags:W,onUploadAdded:w,options:D,signatureEndpoint:_,uploadPreset:u,...M})=>K.createElement(K.Fragment,null,K.createElement(q,{onError:d,onOpen:t,onUpload:r,onAbort:p,onBatchCancelled:y,onClose:C,onDisplayChanged:c,onPublicId:i,onQueuesEnd:U,onQueuesStart:E,onRetry:P,onShowCompleted:n,onSourceChanged:h,onSuccess:O,onTags:W,onUploadAdded:w,options:D,signatureEndpoint:_,uploadPreset:u},({open:x,isLoading:S})=>{function k(V){V.preventDefault(),x(),typeof l=="function"&&l(V)}return K.createElement("button",{...M,className:e||"",onClick:k,disabled:S},o||"Upload")})),Ce=je;import v,{useRef as ae,useEffect as Fe}from"react";import He from"next/script";import Xe from"next/head";import{parseUrl as Be}from"@cloudinary-util/util";import{constructCloudinaryUrl as Re}from"@cloudinary-util/url-loader";function de(e,o,l){var t,r;let d=(r=(t=o==null?void 0:o.cloud)==null?void 0:t.cloudName)!=null?r:process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME;return b(d),Re({options:{assetType:"video",...e},config:Object.assign({cloud:{cloudName:d}},o),analytics:Object.assign({sdkCode:Y,sdkSemver:$,techVersion:z,feature:""},l)})}var Q=[],he="1.10.4",Ye=e=>{let{autoPlay:o,autoplay:l,className:d,colors:t,controls:r=!0,fontFace:p,height:y,id:C,language:c,languages:i,logo:U=!0,loop:E=!1,muted:P=!1,onDataLoad:n,onError:h,onMetadataLoad:O,onPause:W,onPlay:w,onEnded:D,poster:_,src:u,sourceTypes:M,transformation:x,quality:S="auto",width:k,...V}=e,F=Array.isArray(x)?x:[x],T=u||"";if(T.startsWith("http"))try{let s=Be(u);typeof(s==null?void 0:s.publicId)=="string"&&(T=s==null?void 0:s.publicId)}catch(s){}F.unshift({quality:S});let H=ae(),J=ae(),j=e.videoRef||J,X=ae(),A=e.playerRef||X,a=C||`player-${T.replace("/","-")}`,g="cld-video-player cld-fluid";d&&(g=`${g} ${d}`),Q.filter(s=>s===a).length>1?console.warn(`Multiple instances of the same video detected on the
     page which may cause some features to not work. 
    Try adding a unique id to each player.`):Q.push(a);let N={error:h,loadeddata:n,loadedmetadata:O,pause:W,play:w,ended:D};function Z(s){let f=N[s.type];typeof f=="function"&&f(Oe())}b(process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME);function Ue(){if("cloudinary"in window){H.current=window.cloudinary;let s={};typeof U=="boolean"?s.showLogo=U:typeof U=="object"&&(s={...s,showLogo:!0,logoImageUrl:U.imageUrl,logoOnclickUrl:U.onClickUrl});let f=l||o,le=!1,se;o&&process.env.NODE_ENV==="development"&&console.warn('Prop autoPlay will be removed in future versions, please use autoplay (lowercase "p")'),(typeof f=="boolean"||f==="true"||f==="false")&&(le=f),typeof f=="string"&&f!=="true"&&f!=="false"&&(se=f);let G={autoplayMode:se,autoplay:le,cloud_name:process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME,controls:r,fontFace:p||"",language:c,languages:i,loop:E,muted:P,publicId:T,transformation:F,...s,...V};Array.isArray(M)&&(G.sourceTypes=M),typeof t=="object"&&(G.colors=t),typeof _=="string"?G.posterOptions={publicId:_}:typeof _=="object"&&(typeof _.src!="string"?G.posterOptions={publicId:de({..._,src:T,format:"auto:image"})}:G.posterOptions={publicId:I(_)}),A.current=H.current.videoPlayer(j.current,G),Object.keys(N).forEach(pe=>{var ce;typeof N[pe]=="function"&&((ce=A.current)==null||ce.on(pe,Z))})}}Fe(()=>()=>{var s;(s=A.current)==null||s.videojs.cloudinary.dispose(),Q=Q.filter(f=>f!==a)},[]);function Oe(){return{player:A.current,video:j.current}}return v.createElement(v.Fragment,null,v.createElement(Xe,null,v.createElement("link",{href:`https://unpkg.com/cloudinary-video-player@${he}/dist/cld-video-player.min.css`,rel:"stylesheet"})),v.createElement("div",{style:{width:"100%",aspectRatio:`${e.width} / ${e.height}`}},v.createElement("video",{ref:j,id:a,className:g,width:k,height:y}),v.createElement(He,{id:`cloudinary-videoplayer-${a}-${Math.floor(Math.random()*100)}`,src:`https://unpkg.com/cloudinary-video-player@${he}/dist/cld-video-player.min.js`,onLoad:Ue,onError:s=>console.error(`Failed to load Cloudinary Video Player: ${s.message}`)})))},Ie=Ye;function $e(e){return I({...e,crop:e.crop||"fill",format:e.format||"jpg",gravity:e.gravity||"center",height:e.height||1254,width:e.width||2400,widthResize:e.width||1200})}export{ge as CldImage,me as CldOgImage,Ce as CldUploadButton,q as CldUploadWidget,Ie as CldVideoPlayer,ee as cloudinaryLoader,I as getCldImageUrl,$e as getCldOgImageUrl,de as getCldVideoUrl};
//# sourceMappingURL=index.mjs.map