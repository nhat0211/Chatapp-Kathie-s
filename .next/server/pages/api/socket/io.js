"use strict";(()=>{var e={};e.id=813,e.ids=[813],e.modules={11185:e=>{e.exports=require("mongoose")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},29505:e=>{e.exports=import("socket.io")},91578:(e,t,a)=>{a.a(e,async(e,o)=>{try{a.r(t),a.d(t,{config:()=>c,default:()=>d,routeModule:()=>E});var s=a(71802),i=a(47153),n=a(56249),r=a(25830),l=e([r]);r=(l.then?(await l)():l)[0];let d=(0,n.l)(r,"default"),c=(0,n.l)(r,"config"),E=new s.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/socket/io",pathname:"/api/socket/io",bundlePath:"",filename:""},userland:r});o()}catch(e){o(e)}})},92667:(e,t,a)=>{a(11185)},82363:(e,t,a)=>{a.d(t,{Wl:()=>s,ui:()=>o});let o="receive-message",s="typing"},25830:(e,t,a)=>{a.a(e,async(e,o)=>{try{a.r(t),a.d(t,{config:()=>E,default:()=>__WEBPACK_DEFAULT_EXPORT__});var s=a(29505),i=a(82363);a(92667);var n=a(38574),r=a(72225),l=a(11185),d=a.n(l),c=e([s]);s=(c.then?(await c)():c)[0];let E={api:{bodyParser:!1}},p=new Map,_=new Map,updateMessageStatus=async e=>{try{return await n.Z.findByIdAndUpdate(e,{status:"seen"},{new:!0}).populate({path:"sender",select:"avatar email name _id"})}catch(e){console.log("error while updating seen",e)}},handleMessage=async(e,t,a,o)=>{try{let s=await r.Z.findById(e);if(!s)throw Error("Chat doesnt exists");let i={sender:t.senderId,chat:e,status:"sent"};""!==a.trim()&&(i.content=a),o&&(i.document=o);let l=await n.Z.create(i),[d,c]=await Promise.all([lastMessageUpdate(e,l._id),chatAggregate(l._id)]);return[c[0],d]}catch(e){throw Error(e)}};async function lastMessageUpdate(e,t){return await r.Z.findByIdAndUpdate(e,{$set:{lastMessage:t},$inc:{unread:1}},{new:!0}).populate({path:"participants",select:"name avatar email _id"}).populate({path:"lastMessage",populate:{path:"sender",select:"name avatar email _id"}})}async function chatAggregate(e){return await n.Z.aggregate([{$match:{_id:new(d()).Types.ObjectId(e)}},{$lookup:{from:"users",foreignField:"_id",localField:"sender",as:"sender",pipeline:[{$project:{avatar:1,email:1,name:1}}]}},{$addFields:{sender:{$first:"$sender"}}}])}let __WEBPACK_DEFAULT_EXPORT__=(e,t)=>{if(t.socket.server.io)console.log("Socket is already running...");else{console.log("Socket is initializing...");let e=new s.Server(t.socket.server,{path:"/api/socket/io",pingTimeout:6e4});t.socket.server.io=e,e.on("connection",t=>{t.on("REGISTER",({email:a})=>{_.has(a)&&p.delete(_.get(a)),p.set(t.id,a),_.set(a,t.id),console.log("REGISTERED_USER: ",p),console.log("EMAILTOSOCKETMAP: ",_),console.log("SENDING_ACTIVE_USERS: ",p),e.emit("ACTIVE_USERS",Array.from(_.keys()))}),t.on("test",e=>{console.log("got client event test with: ",e)}),t.on("JOIN",({data:e})=>{t.rooms.forEach(a=>{a!==t.id&&a!==e?.id&&t.leave(a)}),t.join(e?._id),t.broadcast.to(e?._id).emit("newjoin",e)}),t.on("SEND_MESSAGE",async({chatId:e,users:a,content:o,status:s,fileContent:n},r)=>{let[l,d]=await handleMessage(e,a,o,n);r(l),t.broadcast.to(d?.id).emit(i.ui,l),t.broadcast.emit("CHAT_UPDATE",d)}),t.on(i.Wl,({chat:e,isTyping:a})=>{t.broadcast.to(e?._id).emit(i.Wl,{isTyping:a})}),t.on("SEEN_MESSAGE",async({messageId:e,chatId:a})=>{let o=await updateMessageStatus(e);t.broadcast.to(a).emit("SEEN_MESSAGE_UPDATE",{updatedMsg:o})}),t.on("OUTGOING_CALL",({sender:e,offer:a,receiver:o})=>{let s=_[o];console.log("SENDIN CALL TO ",s),t.to(s).emit("INCOMING_CALL",{from:e,offer:a})}),t.on("CALL_ACCEPTED",({to:t,ans:a})=>{let o=_[t];e.to(o).emit("CALL_ACCEPTED",{ans:a})}),t.on("ICE_CANDIDATE",({candidate:t,to:a})=>{console.log("SERVER SENDING ICE TO ",a),console.log("THIS IS THE CANDIDATE ",t);let o=_[a];e.to(o).emit("ICE_CANDIDATE",t)}),t.on("disconnect",()=>{console.log("a client disconnected");let a=p.get(t.id);p.delete(t.id),_.delete(a),e.emit("ACTIVE_USERS:REMOVE",a)})})}t.end()};o()}catch(e){o(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),a=t.X(0,[222,715],()=>__webpack_exec__(91578));module.exports=a})();