"use strict";(()=>{var e={};e.id=938,e.ids=[938],e.modules={11185:e=>{e.exports=require("mongoose")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},11541:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>w,originalPathname:()=>q,requestAsyncStorage:()=>x,routeModule:()=>f,serverHooks:()=>S,staticGenerationAsyncStorage:()=>y,staticGenerationBailout:()=>E});var a={};r.r(a),r.d(a,{DELETE:()=>DELETE,GET:()=>GET,dynamic:()=>g});var s=r(10884),n=r(16132),i=r(62294),o=r(46031),c=r(11185),d=r.n(c);let p=new c.Schema({sender:{type:c.Schema.Types.ObjectId,ref:"User"},content:{type:String},chat:{type:c.Schema.Types.ObjectId,ref:"Chat"},status:{type:String},document:{type:String}},{timestamps:!0}),u=c.models.ChatMessage||(0,c.model)("ChatMessage",p);var l=r(60357),m=r(94020),h=r(95798);let g="force-dynamic";async function GET(e,{params:t}){try{await (0,i.P)();let{user:e}=await (0,m.getServerSession)();if(!e)return new h.Z("Unauthenticated");let r=await l.Z.findOne({email:e.email}).select("_id"),{chatId:a}=t,s=await o.Z.findById(a);if(!s)return h.Z.json({error:"No chat exists"},{status:404});let n=s.participants.some(e=>String(e)===String(r._id));if(!n)return new h.Z("Unauthorized");let c=await u.aggregate([{$match:{chat:new(d()).Types.ObjectId(a)}},{$lookup:{from:"users",foreignField:"_id",localField:"sender",as:"sender",pipeline:[{$project:{avatar:1,email:1,name:1}}]}},{$addFields:{sender:{$first:"$sender"}}}]);return h.Z.json({data:c},{status:201})}catch(e){return console.log("[GET_MESSAGES]",e),new h.Z("Internal Server Error")}}async function DELETE(e,{params:t}){try{await (0,i.P)();let{user:e}=await (0,m.getServerSession)(),{chatId:r}=t;if(!e)return new h.Z("Unauthenticated");let a=await l.Z.findOne({email:e.email}).select("_id"),s=await o.Z.findById(r);if(!s)return h.Z.json({error:"No Chat exists"},{status:404});let n=s.participants.some(e=>String(e)===String(a._id));if(!n)return new h.Z("Unauthorized");let[c,d]=await Promise.all([u.deleteMany({chat:r}),o.Z.findByIdAndUpdate(r,{lastMessage:null,unread:0},{returnDocument:"after"})]);return await d.populate({path:"participants",select:"-password -contacts"}),h.Z.json({newChat:d},{status:201})}catch(e){return console.log("[DELETE_MESSAGES]",e),new h.Z("Internal Server Error")}}let f=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/chats/[chatId]/messages/route",pathname:"/api/chats/[chatId]/messages",filename:"route",bundlePath:"app/api/chats/[chatId]/messages/route"},resolvedPagePath:"/Users/quangnhat/Documents/GitHub/Chatapp-Kathie-s/app/api/chats/[chatId]/messages/route.js",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:x,staticGenerationAsyncStorage:y,serverHooks:S,headerHooks:w,staticGenerationBailout:E}=f,q="/api/chats/[chatId]/messages/route"},62294:(e,t,r)=>{r.d(t,{P:()=>connectToDB});var a=r(11185),s=r.n(a);let n=!1;async function connectToDB(){if(n){console.log("db connected from database config");return}try{await s().connect(process.env.MONGODB_URI),n=!0,console.log("db connected from database config")}catch(e){console.log("error occured "+e)}}},46031:(e,t,r)=>{r.d(t,{Z:()=>i});var a=r(11185);let s=new a.Schema({lastMessage:{type:a.Schema.Types.ObjectId,ref:"ChatMessage"},participants:[{type:a.Schema.Types.ObjectId,ref:"User"}],unread:{type:Number,default:0}},{timestamps:!0}),n=a.models.Chat||(0,a.model)("Chat",s),i=n}};var t=require("../../../../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),r=t.X(0,[657,449,11,674,107,20,357],()=>__webpack_exec__(11541));module.exports=r})();