import _e,{useState as xe,useCallback as Le,forwardRef as Ne}from"react";import be from"next/image";import{getTransformations as Te}from"@cloudinary-util/util";import{transformationPlugins as Ae}from"@cloudinary-util/url-loader";async function B(e){let{src:o}=e;try{await new Promise((l,a)=>{fetch(o).then(t=>{if(!t.ok){a(t);return}l(t)})})}catch(l){return l.status===423?await B(e):!1}return!0}function L(e){if(!e)throw new Error("A Cloudinary Cloud name is required, please make sure NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME is set and configured in your environment.")}import{constructCloudinaryUrl as we}from"@cloudinary-util/url-loader";import Pe from"next/package.json";var ue={name:"next-cloudinary",version:"5.18.0",license:"MIT",main:"./dist/index.js",module:"./dist/index.mjs",types:"./dist/index.d.ts",source:"src/index.ts",scripts:{build:"tsup",dev:"tsup --watch",prepublishOnly:"cp ../README.md . && cp ../LICENSE . && yarn build",postpublish:"rm ./README.md && rm ./LICENSE",test:"jest","test:app":'NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME="test" yarn build && cd tests/nextjs-app && yarn build'},dependencies:{"@cloudinary-util/url-loader":"^3.22.0","@cloudinary-util/util":"^2.3.0"},devDependencies:{"@babel/core":"^7.23.2","@babel/preset-env":"^7.23.2","@types/jest":"^29.5.6","@types/react":"^18.2.33","@types/react-dom":"^18.2.14","babel-jest":"^29.7.0",dotenv:"^16.3.1",jest:"^29.7.0","jest-environment-jsdom":"^29.7.0",mkdirp:"^3.0.1","ts-jest":"^29.1.1",tsup:"^7.2.0",typescript:"^5.2.2"},peerDependencies:{next:"^12 || ^13 || ^14",react:"^17 || ^18"}};var Y="V",$=ue.version,z=Pe.version;function I(e,o,l){var t,r;let a=(r=(t=o==null?void 0:o.cloud)==null?void 0:t.cloudName)!=null?r:process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME;return L(a),we({options:e,config:Object.assign({cloud:{cloudName:a}},o),analytics:Object.assign({sdkCode:Y,sdkSemver:$,techVersion:z,feature:""},l)})}function ee({loaderOptions:e,imageProps:o,cldOptions:l,cldConfig:a={}}){let t={...o,...l};t.width=typeof t.width=="string"?parseInt(t.width):t.width,t.height=typeof t.height=="string"?parseInt(t.height):t.height;let r;return typeof(e==null?void 0:e.width)=="number"&&typeof t.width=="number"&&e.width!==t.width?r=e.width:typeof(e==null?void 0:e.width)=="number"&&typeof(t==null?void 0:t.width)!="number"&&(r=e.width,t.width=r),t.width&&r&&r<t.width&&(t.widthResize=e.width),I(t,a)}var ve=Ne(function(o,l){let a=!1,t=["deliveryType","preserveTransformations","strictTransformations","assetType"];Ae.forEach(({props:n=[]})=>{n.forEach(u=>{if(t.includes(u))throw new Error(`Option ${u} already exists!`);t.push(u)})});let r={alt:o.alt,src:o.src};Object.keys(o).filter(n=>!t.includes(n)).forEach(n=>r[n]=o[n]);let c=Object.keys(r).map(n=>`${n}:${r[n]}`).join(";"),[C,h]=xe(c),p={};if(t.forEach(n=>{o[n]&&(p[n]=o[n]||void 0)}),o.preserveTransformations)try{let n=Te(o.src).map(u=>u.join(","));p.rawTransformations=[...n.flat(),...o.rawTransformations||[]]}catch(n){console.warn(`Failed to preserve transformations: ${n.message}`)}let i=process.env.__NEXT_IMAGE_OPTS||{};(o.unoptimized===!0||(i==null?void 0:i.unoptimized)===!0)&&(r.src=I({...p,width:r.width,height:r.height,src:r.src,format:"default",quality:"default"},o.config));async function U(n){let u=!0;if(a)return;if(a=!0,typeof o.onError=="function"){let P=o.onError(n);typeof P=="boolean"&&P===!1&&(u=!1)}else typeof o.onError=="boolean"&&o.onError===!1&&(u=!1);if(u===!1)return;let N=n.target;await B({src:N.src})&&h(`${c};${Date.now()}`)}let O=Le(U,[B,c]),E=be;return"default"in E&&(E=E.default),_e.createElement(E,{key:C,...r,loader:n=>ee({loaderOptions:n,imageProps:r,cldOptions:p,cldConfig:o.config}),onError:O,ref:l})}),me=ve;import _ from"react";import Me from"next/head";var We="summary_large_image",Ve=({excludeTags:e=[],twitterTitle:o,keys:l={},...a})=>{let{alt:t}=a,r={...a,crop:a.crop||"fill",gravity:a.gravity||"center",height:a.height||1254,src:a.src,width:a.width||2400,widthResize:a.width||1200},c=typeof r.width=="string"?parseInt(r.width):r.width,C=typeof r.height=="string"?parseInt(r.height):r.height;typeof C=="number"&&typeof c=="number"&&(C=1200/c*C),c=1200;let h=I({...r,format:a.format||"jpg"}),p=I({...r,format:a.format||"webp"}),i={"og:image":"og-image","og:image:secure_url":"og-image-secureurl","og:image:width":"og-image-width","og:image:height":"og-image-height","og:image:alt":"og-image-alt","twitter:title":"twitter-title","twitter:card":"twitter-card","twitter:image":"twitter-image",...l};return _.createElement(Me,null,_.createElement("meta",{key:i["og:image"],property:"og:image",content:h}),_.createElement("meta",{key:i["og:image:secure_url"],property:"og:image:secure_url",content:h}),_.createElement("meta",{key:i["og:image:width"],property:"og:image:width",content:`${c}`}),_.createElement("meta",{key:i["og:image:height"],property:"og:image:height",content:`${C}`}),t&&_.createElement("meta",{key:i["og:image:alt"],property:"og:image:alt",content:t}),!e.includes("twitter:title")&&_.createElement("meta",{key:i["twitter:title"],property:"twitter:title",content:o||" "}),_.createElement("meta",{key:i["twitter:card"],property:"twitter:card",content:We}),_.createElement("meta",{key:i["twitter:image"],property:"twitter:image",content:p}))},ge=Ve;import K from"react";import re,{useState as ne,useEffect as ie,useRef as ye}from"react";import Ge from"next/script";function fe(e){return window&&"requestIdleCallback"in window?requestIdleCallback(e):setTimeout(()=>e(),1)}var De=["success","display-changed"],Se={abort:"onAbort","batch-cancelled":"onBatchCancelled","display-changed":"onDisplayChanged",publicid:"onPublicId","queues-end":"onQueuesEnd","queues-start":"onQueuesStart",retry:"onRetry","show-completed":"onShowCompleted","source-changed":"onSourceChanged",success:"onSuccess",tags:"onTags","upload-added":"onUploadAdded"},ke=({children:e,onClose:o,onError:l,onOpen:a,onUpload:t,options:r,signatureEndpoint:c,uploadPreset:C,...h})=>{let p=ye(),i=ye(),U=!!c,[O,E]=ne(void 0),[n,u]=ne(void 0),[N,M]=ne(!0),P={cloudName:process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME,uploadPreset:C||process.env.NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET,apiKey:process.env.NEXT_PUBLIC_CLOUDINARY_API_KEY,...r};L(process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME),U&&(P.uploadSignature=w,P.apiKey||console.warn("Missing dependency: Signed Upload requires an API key")),ie(()=>{if(typeof n=="undefined")return;let d=n.event==="success",g=n.event==="display-changed"&&n.info==="hidden";d&&typeof t=="function"&&t(n,i.current),g&&typeof o=="function"&&o(i.current)},[n]),ie(()=>{O&&typeof l=="function"&&l(O,i.current)},[O]);function D(){M(!1),p.current||(p.current=window.cloudinary),fe(()=>{i.current||(i.current=A())})}ie(()=>()=>{var d;(d=i.current)==null||d.destroy(),i.current=void 0},[]);function w(d,g){if(typeof c=="undefined")throw Error("Failed to generate signature: signatureEndpoint undefined.");fetch(c,{method:"POST",body:JSON.stringify({paramsToSign:g})}).then(f=>f.json()).then(({signature:f})=>{d(f)})}function m(d,g=[]){if(i.current||(i.current=A()),typeof(i==null?void 0:i.current[d])=="function")return i.current[d](...g)}function W(d){m("close",[d])}function b(d){return m("destroy",[d])}function S(){m("hide")}function k(){return m("isDestroyed")}function V(){return m("isMinimized")}function F(){return m("isShowing")}function T(){m("minimize")}function H(d,g){m("open",[d,g]),typeof a=="function"&&a(i.current)}function J(){m("show")}function j(){m("update")}let X={close:W,destroy:b,hide:S,isDestroyed:k,isMinimized:V,isShowing:F,minimize:T,open:H,show:J,update:j};function A(){var d;return(d=p.current)==null?void 0:d.createUploadWidget(P,(g,f)=>{if(g&&g!==null&&E(g),typeof(f==null?void 0:f.event)=="string"){De.includes(f==null?void 0:f.event)&&u(f);let x=Se[f.event];if(typeof x=="string"&&typeof h[x]=="function"&&typeof h[x]){let Z=h[x];Z(f,{widget:i.current,...X})}}})}return re.createElement(re.Fragment,null,typeof e=="function"&&e({cloudinary:p.current,widget:i.current,results:n,error:O,isLoading:N,...X}),re.createElement(Ge,{id:`cloudinary-uploadwidget-${Math.floor(Math.random()*100)}`,src:"https://upload-widget.cloudinary.com/global/all.js",onLoad:D,onError:d=>console.error(`Failed to load Cloudinary Upload Widget: ${d.message}`)}))},q=ke;var je=({className:e,children:o,onClick:l,onError:a,onOpen:t,onUpload:r,onAbort:c,onBatchCancelled:C,onClose:h,onDisplayChanged:p,onPublicId:i,onQueuesEnd:U,onQueuesStart:O,onRetry:E,onShowCompleted:n,onSourceChanged:u,onSuccess:N,onTags:M,onUploadAdded:P,options:D,signatureEndpoint:w,uploadPreset:m,...W})=>K.createElement(K.Fragment,null,K.createElement(q,{onError:a,onOpen:t,onUpload:r,onAbort:c,onBatchCancelled:C,onClose:h,onDisplayChanged:p,onPublicId:i,onQueuesEnd:U,onQueuesStart:O,onRetry:E,onShowCompleted:n,onSourceChanged:u,onSuccess:N,onTags:M,onUploadAdded:P,options:D,signatureEndpoint:w,uploadPreset:m},({open:b,isLoading:S})=>{function k(V){V.preventDefault(),b(),typeof l=="function"&&l(V)}return K.createElement("button",{...W,className:e||"",onClick:k,disabled:S},o||"Upload")})),Ce=je;import v,{useRef as de,useEffect as Fe}from"react";import He from"next/script";import Xe from"next/head";import{parseUrl as Be}from"@cloudinary-util/util";import{constructCloudinaryUrl as Re}from"@cloudinary-util/url-loader";function ae(e,o,l){var t,r;let a=(r=(t=o==null?void 0:o.cloud)==null?void 0:t.cloudName)!=null?r:process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME;return L(a),Re({options:{assetType:"video",...e},config:Object.assign({cloud:{cloudName:a}},o),analytics:Object.assign({sdkCode:Y,sdkSemver:$,techVersion:z,feature:""},l)})}var Q=[],he="1.10.4",Ye=e=>{let{autoPlay:o,autoplay:l,className:a,colors:t,controls:r=!0,fontFace:c,height:C,id:h,language:p,languages:i,logo:U=!0,loop:O=!1,muted:E=!1,onDataLoad:n,onError:u,onMetadataLoad:N,onPause:M,onPlay:P,onEnded:D,poster:w,src:m,sourceTypes:W,transformation:b,quality:S="auto",width:k,...V}=e,F=Array.isArray(b)?b:[b],T=m||"";if(T.startsWith("http"))try{let s=Be(m);typeof(s==null?void 0:s.publicId)=="string"&&(T=s==null?void 0:s.publicId)}catch(s){}F.unshift({quality:S});let H=de(),J=de(),j=e.videoRef||J,X=de(),A=e.playerRef||X,d=h||`player-${T.replace("/","-")}`,g="cld-video-player cld-fluid";a&&(g=`${g} ${a}`),Q.filter(s=>s===d).length>1?console.warn(`Multiple instances of the same video detected on the
     page which may cause some features to not work. 
    Try adding a unique id to each player.`):Q.push(d);let x={error:u,loadeddata:n,loadedmetadata:N,pause:M,play:P,ended:D};function Z(s){let y=x[s.type];typeof y=="function"&&y(Oe())}L(process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME);function Ue(){if("cloudinary"in window){H.current=window.cloudinary;let s={};typeof U=="boolean"?s.showLogo=U:typeof U=="object"&&(s={...s,showLogo:!0,logoImageUrl:U.imageUrl,logoOnclickUrl:U.onClickUrl});let y=l||o,le=!1,se;o&&process.env.NODE_ENV==="development"&&console.warn('Prop autoPlay will be removed in future versions, please use autoplay (lowercase "p")'),(typeof y=="boolean"||y==="true"||y==="false")&&(le=y),typeof y=="string"&&y!=="true"&&y!=="false"&&(se=y);let G={autoplayMode:se,autoplay:le,cloud_name:process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME,controls:r,fontFace:c||"",language:p,languages:i,loop:O,muted:E,publicId:T,transformation:F,...s,...V};Array.isArray(W)&&(G.sourceTypes=W),typeof t=="object"&&(G.colors=t),typeof w=="string"?G.posterOptions={publicId:w}:typeof w=="object"&&(typeof w.src!="string"?G.posterOptions={publicId:ae({...w,src:T,format:"auto:image"})}:G.posterOptions={publicId:I(w)}),A.current=H.current.videoPlayer(j.current,G),Object.keys(x).forEach(ce=>{var pe;typeof x[ce]=="function"&&((pe=A.current)==null||pe.on(ce,Z))})}}Fe(()=>()=>{var s;(s=A.current)==null||s.videojs.cloudinary.dispose(),Q=Q.filter(y=>y!==d)},[]);function Oe(){return{player:A.current,video:j.current}}return v.createElement(v.Fragment,null,v.createElement(Xe,null,v.createElement("link",{href:`https://unpkg.com/cloudinary-video-player@${he}/dist/cld-video-player.min.css`,rel:"stylesheet"})),v.createElement("div",{style:{width:"100%",aspectRatio:`${e.width} / ${e.height}`}},v.createElement("video",{ref:j,id:d,className:g,width:k,height:C}),v.createElement(He,{id:`cloudinary-videoplayer-${d}-${Math.floor(Math.random()*100)}`,src:`https://unpkg.com/cloudinary-video-player@${he}/dist/cld-video-player.min.js`,onLoad:Ue,onError:s=>console.error(`Failed to load Cloudinary Video Player: ${s.message}`)})))},Ie=Ye;function $e(e){return I({...e,crop:e.crop||"fill",format:e.format||"jpg",gravity:e.gravity||"center",height:e.height||1254,width:e.width||2400,widthResize:e.width||1200})}export{me as CldImage,ge as CldOgImage,Ce as CldUploadButton,q as CldUploadWidget,Ie as CldVideoPlayer,ee as cloudinaryLoader,I as getCldImageUrl,$e as getCldOgImageUrl,ae as getCldVideoUrl};
//# sourceMappingURL=index.mjs.map